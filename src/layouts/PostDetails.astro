---
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import type { CollectionEntry } from "astro:content";
import { slugifyStr } from "@utils/slugify";
import { SITE } from "@config";

export interface Props {
  post: CollectionEntry<"blog">;
  prevPost?: CollectionEntry<"blog">;
  nextPost?: CollectionEntry<"blog">;
}

const { post, prevPost, nextPost } = Astro.props;

const {
  title,
  author,
  description,
  ogImage,
  canonicalURL,
  pubDatetime,
  modDatetime,
  tags,
} = post.data;

const { Content } = await post.render();

const ogImageUrl = typeof ogImage === "string" ? ogImage : ogImage?.src;
const ogUrl = new URL(
  ogImageUrl ?? `/posts/${slugifyStr(title)}.png`,
  Astro.url.origin
).href;

const layoutProps = {
  title: `${title} | ${SITE.title}`,
  author,
  description,
  pubDatetime,
  modDatetime,
  canonicalURL,
  ogImage: ogUrl,
  scrollSmooth: true,
};

// Format date helper
function formatDate(date: Date): string {
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

// Reading time estimate (rough calculation)
function getReadingTime(content: string): string {
  const wordsPerMinute = 200;
  const wordCount = content.split(/\s+/).length;
  const minutes = Math.ceil(wordCount / wordsPerMinute);
  return `${minutes} min read`;
}
---

<Layout {...layoutProps}>
  <Header activeNav="posts" />

  <main id="main-content" class="single-post">
    <!-- Post Header -->
    <header class="single-post-header">
      <div class="single-post-header-content">
        <div class="single-post-meta">
          {
            tags && tags[0] && (
              <a
                href={`/tags/${slugifyStr(tags[0])}/`}
                class="single-post-category"
              >
                {tags[0]}
              </a>
            )
          }
          <span class="single-post-date">{formatDate(pubDatetime)}</span>
        </div>

        <h1 class="single-post-title" transition:name={slugifyStr(title)}>
          {title}
        </h1>

        {description && <p class="single-post-excerpt">{description}</p>}

        <div class="single-post-author">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="var(--primary-light)"
          >
            <path
              d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"
            ></path>
          </svg>
          <div class="single-post-author-info">
            <span class="single-post-author-name">{author || SITE.author}</span>
            <span class="single-post-reading-time">~5 min read</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Post Content -->
    <article class="single-post-content prose">
      <Content />
    </article>

    <!-- Post Footer -->
    <footer class="single-post-footer">
      {
        tags && tags.length > 0 && (
          <div class="single-post-tags">
            <span class="single-post-tags-label">Tags:</span>
            {tags.map(tag => (
              <a href={`/tags/${slugifyStr(tag)}/`} class="single-post-tag">
                {tag}
              </a>
            ))}
          </div>
        )
      }

      <!-- Post Navigation -->
      <nav class="single-post-nav">
        {
          prevPost && (
            <a
              href={`/posts/${prevPost.slug}/`}
              class="single-post-nav-link single-post-nav-prev"
            >
              <span class="single-post-nav-label">← Previous</span>
              <span class="single-post-nav-title">{prevPost.data.title}</span>
            </a>
          )
        }
        {
          nextPost && (
            <a
              href={`/posts/${nextPost.slug}/`}
              class="single-post-nav-link single-post-nav-next"
            >
              <span class="single-post-nav-label">Next →</span>
              <span class="single-post-nav-title">{nextPost.data.title}</span>
            </a>
          )
        }
      </nav>
    </footer>
  </main>

  <Footer />
</Layout>

<script is:inline>
  /** Attaches links to headings in the document */
  function addHeadingLinks() {
    let headings = Array.from(document.querySelectorAll("h2, h3, h4, h5, h6"));
    for (let heading of headings) {
      if (heading.id) {
        heading.style.cursor = "pointer";
        heading.addEventListener("click", () => {
          window.location.hash = heading.id;
        });
      }
    }
  }
  addHeadingLinks();

  /** Attaches copy buttons to code blocks */
  function attachCopyButtons() {
    let copyButtonLabel = "Copy";
    let codeBlocks = Array.from(document.querySelectorAll("pre"));

    for (let codeBlock of codeBlocks) {
      let wrapper = document.createElement("div");
      wrapper.style.position = "relative";

      let copyButton = document.createElement("button");
      copyButton.className = "copy-code";
      copyButton.style.cssText =
        "position: absolute; right: 8px; top: 8px; padding: 4px 8px; background: var(--accent); color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;";
      copyButton.innerHTML = copyButtonLabel;
      codeBlock.setAttribute("tabindex", "0");
      codeBlock.appendChild(copyButton);

      codeBlock?.parentNode?.insertBefore(wrapper, codeBlock);
      wrapper.appendChild(codeBlock);

      copyButton.addEventListener("click", async () => {
        let code = codeBlock.querySelector("code");
        let text = code?.innerText;
        await navigator.clipboard.writeText(text ?? "");
        copyButton.innerText = "Copied!";
        setTimeout(() => {
          copyButton.innerText = copyButtonLabel;
        }, 700);
      });
    }
  }
  attachCopyButtons();
</script>
